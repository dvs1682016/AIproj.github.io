<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å®‰å¿ƒæ—¥å¸¸è¨˜éŒ„ï¼ˆç¤ºç¯„ç‰ˆï¼‰</title>
  <meta name="theme-color" content="#111827" />
  <style>
    :root{
      --bg:#0b1220;
      --card:#111827;
      --muted:#9ca3af;
      --text:#f9fafb;
      --accent:#22c55e;
      --accent2:#60a5fa;
      --danger:#ef4444;
      --border:rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 30% -10%, rgba(96,165,250,.18), transparent 60%),
                  radial-gradient(900px 700px at 90% 10%, rgba(34,197,94,.16), transparent 55%),
                  var(--bg);
      color:var(--text);
      padding:18px;
    }
    .wrap{max-width:920px;margin:0 auto}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      margin-bottom:14px;
    }
    h1{font-size:22px;margin:0;letter-spacing:.5px}
    .sub{font-size:13px;color:var(--muted);margin-top:4px}
    .pill{
      font-size:12px;color:var(--muted);
      border:1px solid var(--border);
      padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.03);
      white-space:nowrap;
    }
    .card{
      border:1px solid var(--border);
      background:rgba(17,24,39,.92);
      border-radius:16px;
      padding:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.28);
      margin-bottom:14px;
    }

    .dateRow{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      align-items:center;
    }
    .dateControls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
    }
    .dateBox{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    }
    .btnRow{display:flex;gap:10px;flex-wrap:wrap}
    button{
      appearance:none;border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      color:var(--text);
      padding:12px 14px;border-radius:12px;
      font-size:16px;
      cursor:pointer;
      min-height:48px;
    }
    button:active{transform:scale(.99)}
    button.primary{
      border-color: rgba(34,197,94,.45);
      background: rgba(34,197,94,.16);
    }
    button.ghost{
      border-color: rgba(96,165,250,.45);
      background: rgba(96,165,250,.14);
    }
    button.danger{
      border-color: rgba(239,68,68,.5);
      background: rgba(239,68,68,.14);
    }

    input[type="date"]{
      background:rgba(255,255,255,.06);
      border:1px solid var(--border);
      color:var(--text);
      padding:12px 14px;
      border-radius:12px;
      font-size:16px;
      min-height:48px;
    }
    .hint{color:var(--muted);font-size:13px;line-height:1.5}

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 720px){
      .grid{grid-template-columns: 1fr 1fr}
    }

    .metric{
      padding:14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
    }
    .metric h2{
      margin:0 0 8px 0;
      font-size:18px;
      display:flex;align-items:baseline;justify-content:space-between;gap:10px;
    }
    .value{
      font-size:26px;
      font-weight:800;
      letter-spacing:.5px;
    }
    .unit{font-size:13px;color:var(--muted);font-weight:600;margin-left:6px}
    .rangeRow{display:flex;align-items:center;gap:10px;margin-top:8px}
    .minmax{font-size:12px;color:var(--muted);min-width:58px;text-align:center}
    input[type="range"]{
      width:100%;
      height:26px;
      accent-color: var(--accent2);
    }

    textarea{
      width:100%;
      min-height:110px;
      resize:vertical;
      background:rgba(255,255,255,.06);
      border:1px solid var(--border);
      color:var(--text);
      padding:12px 14px;
      border-radius:12px;
      font-size:16px;
      line-height:1.6;
      outline:none;
    }
    textarea::placeholder{color:rgba(156,163,175,.75)}
    .footerRow{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between
    }
    .status{
      color:var(--muted);
      font-size:13px;
    }

    /* æ­·å²æ¸…å–® */
    .historyTop{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      margin-bottom:10px;
    }
    .historyControls{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    }
    .list{
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background:rgba(255,255,255,.03);
    }
    .row{
      display:grid;
      grid-template-columns: 120px 1fr 1fr 1fr 110px;
      gap:10px;
      padding:12px 12px;
      border-top:1px solid rgba(255,255,255,.08);
      align-items:center;
      font-size:15px;
    }
    .row:first-child{border-top:none}
    .row.head{
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-size:13px;
    }
    .row .mono{font-variant-numeric: tabular-nums}
    .row button{
      min-height:40px;
      padding:8px 10px;
      font-size:14px;
      border-radius:10px;
    }
    .empty{
      padding:14px;
      color:var(--muted);
      font-size:14px;
    }
    @media (max-width: 860px){
      .row{grid-template-columns: 110px 1fr 1fr 1fr 86px}
    }
    @media (max-width: 720px){
      .row{grid-template-columns: 1fr; gap:6px}
      .row.head{display:none}
    }

    .toast{
      position:fixed;
      left:50%; bottom:18px;
      transform:translateX(-50%);
      background: rgba(17,24,39,.95);
      border:1px solid var(--border);
      padding:10px 12px;
      border-radius:999px;
      color:var(--text);
      font-size:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-2px);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>å®‰å¿ƒæ—¥å¸¸è¨˜éŒ„ï¼ˆç¤ºç¯„ç‰ˆï¼‰</h1>
        <div class="sub">æ‰‹æ©Ÿå‹å–„ãƒ»å–®ä¸€ HTMLãƒ»è‡ªå‹•å„²å­˜ï¼ˆæœ¬æ©Ÿï¼‰</div>
      </div>
      <div class="pill" id="storagePill">å„²å­˜ï¼šæœ¬æ©Ÿï¼ˆlocalStorageï¼‰</div>
    </header>

    <section class="card">
      <div class="dateRow">
        <div class="dateControls">
          <div class="dateBox">
            <strong style="font-size:16px;">æ—¥æœŸ</strong>
            <input id="dateInput" type="date" />
            <button class="ghost" id="btnToday">ä»Šå¤©</button>
          </div>

          <div class="btnRow">
            <button id="btnPrev">å‰ä¸€å¤©</button>
            <button id="btnNext">å¾Œä¸€å¤©</button>
          </div>
        </div>
        <div class="hint">
          å°æé†’ï¼šé€™å€‹ç‰ˆæœ¬æœƒæŠŠè³‡æ–™å­˜åœ¨æ‰‹æ©Ÿæœ¬æ©Ÿï¼ˆä¸éœ€ç™»å…¥ï¼‰ã€‚ä½ æ›æ‰‹æ©Ÿå°±æœƒæ¶ˆå¤±â€”â€”ä¹‹å¾Œæˆ‘å€‘å†å‡ç´šæˆ IndexedDB / é›²ç«¯ç‰ˆã€‚
        </div>
      </div>
    </section>

    <section class="card">
      <div class="grid">
        <div class="metric">
          <h2>
            <span>èˆ’å¼µå£“</span>
            <span class="value"><span id="diaVal">120</span><span class="unit">mmHg</span></span>
          </h2>
          <div class="rangeRow">
            <div class="minmax">40</div>
            <input id="diaRange" type="range" min="40" max="140" step="1" value="120" />
            <div class="minmax">140</div>
          </div>
          <div class="hint">æ»‘æ¡¿å¾€å³è®Šå¤§ã€å¾€å·¦è®Šå°ï¼ˆé è¨­ 120ï¼‰</div>
        </div>

        <div class="metric">
          <h2>
            <span>æ”¶ç¸®å£“</span>
            <span class="value"><span id="sysVal">70</span><span class="unit">mmHg</span></span>
          </h2>
          <div class="rangeRow">
            <div class="minmax">70</div>
            <input id="sysRange" type="range" min="70" max="220" step="1" value="70" />
            <div class="minmax">220</div>
          </div>
          <div class="hint">ä¾ä½ å…ˆå‰è¨­å®šï¼šé è¨­ 70ï¼ˆä¹‹å¾Œä¹Ÿå¯ä¸€éµæ”¹æˆ 120ï¼‰</div>
        </div>

        <div class="metric">
          <h2>
            <span>å¿ƒè·³</span>
            <span class="value"><span id="hrVal">70</span><span class="unit">æ¬¡/åˆ†</span></span>
          </h2>
          <div class="rangeRow">
            <div class="minmax">40</div>
            <input id="hrRange" type="range" min="40" max="140" step="1" value="70" />
            <div class="minmax">140</div>
          </div>
          <div class="hint">é è¨­ 70</div>
        </div>

        <div class="metric">
          <h2 style="margin-bottom:10px;">å‚™è¨»ï¼ˆç”¨è—¥ï¼æ„Ÿè¦ºï¼‰</h2>
          <textarea id="noteInput" placeholder="ä¾‹å¦‚ï¼šæ—©ä¸Šé£¯å¾Œåƒè—¥ã€é ­æšˆã€ç¡å¾—ä¸éŒ¯ã€èµ°è·¯ 30 åˆ†é˜â€¦"></textarea>
          <div class="hint" style="margin-top:8px;">æ‰“å­—å¾Œæœƒè‡ªå‹•å„²å­˜ï¼ˆä¸ç”¨æŒ‰å¾ˆå¤šæ¬¡ï¼‰ã€‚</div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="footerRow">
        <div class="btnRow">
          <button class="primary" id="btnSave">ç«‹å³å„²å­˜</button>
          <button class="danger" id="btnClearDay">æ¸…é™¤ç•¶æ—¥</button>
        </div>
        <div class="status" id="statusText">å°šæœªå„²å­˜</div>
      </div>
    </section>

    <!-- âœ… æ–°å¢ï¼šæ­·å²ç´€éŒ„ -->
    <section class="card">
      <div class="historyTop">
        <div>
          <strong style="font-size:16px;">æ­·å²ç´€éŒ„</strong>
          <div class="hint" id="historyHint">é è¨­é¡¯ç¤ºæœ€è¿‘ 7 å¤©ï¼ˆå¯ç”¨å€é–“æŸ¥è©¢ï¼‰</div>
        </div>

        <div class="historyControls">
          <button class="ghost" id="btnLast7">æœ€è¿‘7å¤©</button>
          <button class="ghost" id="btnLast30">æœ€è¿‘30å¤©</button>
        </div>
      </div>

      <div class="historyControls" style="justify-content:flex-start; margin-bottom:10px;">
        <div class="dateBox">
          <span class="hint">èµ·æ—¥</span>
          <input id="fromDate" type="date" />
        </div>
        <div class="dateBox">
          <span class="hint">è¿„æ—¥</span>
          <input id="toDate" type="date" />
        </div>
        <button class="primary" id="btnQuery">æŸ¥è©¢</button>
        <button id="btnResetQuery">é‡è¨­</button>
      </div>

      <div class="list" id="historyList">
        <div class="row head">
          <div>æ—¥æœŸ</div>
          <div>èˆ’å¼µå£“</div>
          <div>æ”¶ç¸®å£“</div>
          <div>å¿ƒè·³</div>
          <div>è¼‰å…¥</div>
        </div>
        <div class="empty" id="emptyText">å°šç„¡è³‡æ–™</div>
      </div>
      <div class="hint" style="margin-top:10px;">æç¤ºï¼šé»ã€Œè¼‰å…¥ã€å¯ç›´æ¥å›åˆ°é‚£ä¸€å¤©ä¿®æ”¹ã€‚</div>
    </section>
  </div>

  <div class="toast" id="toast">å·²å„²å­˜ âœ…</div>

  <script>
    const STORAGE_KEY = "anxin_daily_records_v1";

    const DEFAULTS = { dia: 120, sys: 70, hr: 70, note: "" };

    const el = {
      dateInput: document.getElementById("dateInput"),
      btnPrev: document.getElementById("btnPrev"),
      btnNext: document.getElementById("btnNext"),
      btnToday: document.getElementById("btnToday"),
      btnSave: document.getElementById("btnSave"),
      btnClearDay: document.getElementById("btnClearDay"),

      diaRange: document.getElementById("diaRange"),
      sysRange: document.getElementById("sysRange"),
      hrRange: document.getElementById("hrRange"),
      noteInput: document.getElementById("noteInput"),

      diaVal: document.getElementById("diaVal"),
      sysVal: document.getElementById("sysVal"),
      hrVal: document.getElementById("hrVal"),

      statusText: document.getElementById("statusText"),
      toast: document.getElementById("toast"),

      // history
      btnLast7: document.getElementById("btnLast7"),
      btnLast30: document.getElementById("btnLast30"),
      fromDate: document.getElementById("fromDate"),
      toDate: document.getElementById("toDate"),
      btnQuery: document.getElementById("btnQuery"),
      btnResetQuery: document.getElementById("btnResetQuery"),
      historyList: document.getElementById("historyList"),
      emptyText: document.getElementById("emptyText"),
      historyHint: document.getElementById("historyHint"),
    };

    let saveTimer = null;
    let dirty = false;

    function pad2(n){ return String(n).padStart(2, "0"); }
    function toISODate(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
    function fromISODate(s){ const [y,m,dd]=s.split("-").map(Number); return new Date(y, m-1, dd); }
    function addDays(iso, delta){ const d=fromISODate(iso); d.setDate(d.getDate()+delta); return toISODate(d); }

    function loadAll(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }
      catch{ return {}; }
    }
    function saveAll(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }
    function getRecord(dateStr){ const all=loadAll(); return all[dateStr] || null; }
    function setRecord(dateStr, record){ const all=loadAll(); all[dateStr]=record; saveAll(all); }
    function deleteRecord(dateStr){ const all=loadAll(); delete all[dateStr]; saveAll(all); }

    function setDirty(flag){
      dirty = flag;
      el.statusText.textContent = flag ? "å°šæœªå„²å­˜ï¼ˆæœƒè‡ªå‹•å„²å­˜ï¼‰" : "å·²å„²å­˜";
    }

    function showToast(text="å·²å„²å­˜ âœ…"){
      el.toast.textContent = text;
      el.toast.classList.add("show");
      setTimeout(()=> el.toast.classList.remove("show"), 900);
    }

    function refreshNumbers(){
      el.diaVal.textContent = el.diaRange.value;
      el.sysVal.textContent = el.sysRange.value;
      el.hrVal.textContent  = el.hrRange.value;
    }

    function applyToUI(record){
      const r = record || DEFAULTS;
      el.diaRange.value = r.dia ?? DEFAULTS.dia;
      el.sysRange.value = r.sys ?? DEFAULTS.sys;
      el.hrRange.value  = r.hr  ?? DEFAULTS.hr;
      el.noteInput.value = r.note ?? DEFAULTS.note;
      refreshNumbers();
    }

    function readFromUI(){
      return {
        dia: Number(el.diaRange.value),
        sys: Number(el.sysRange.value),
        hr: Number(el.hrRange.value),
        note: String(el.noteInput.value || "").trim(),
        updatedAt: new Date().toISOString()
      };
    }

    function scheduleAutoSave(){
      setDirty(true);
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(() => saveNow(true), 500);
    }

    function saveNow(isAuto=false){
      const dateStr = el.dateInput.value;
      if (!dateStr) return;

      setRecord(dateStr, readFromUI());
      setDirty(false);
      showToast(isAuto ? "è‡ªå‹•å„²å­˜ âœ…" : "å·²å„²å­˜ âœ…");

      // å„²å­˜å¾Œåˆ·æ–°æ­·å²æ¸…å–®ï¼ˆç¶­æŒç›®å‰æŸ¥è©¢æ¢ä»¶ï¼‰
      refreshHistoryKeepCurrentQuery();
    }

    function switchDate(newDateStr){
      if (dirty) saveNow(true);

      el.dateInput.value = newDateStr;
      const rec = getRecord(newDateStr);
      applyToUI(rec);
      setDirty(false);
      el.statusText.textContent = rec ? "å·²è¼‰å…¥ï¼ˆå¯ç›´æ¥ä¿®æ”¹ï¼‰" : "æ–°çš„ä¸€å¤©ï¼ˆå°šæœªæœ‰ç´€éŒ„ï¼‰";
    }

    // -------- æ­·å²æ¸…å–® --------
    let currentQuery = { mode: "last7" }; // é è¨­æœ€è¿‘ 7 å¤©

    function clearHistoryRows(){
      // ä¿ç•™è¡¨é ­ã€emptyText
      [...el.historyList.querySelectorAll(".row.data")].forEach(n => n.remove());
    }

    function buildHistoryRow(dateStr, rec){
      const row = document.createElement("div");
      row.className = "row data";
      row.innerHTML = `
        <div class="mono"><strong>${dateStr}</strong></div>
        <div class="mono">èˆ’å¼µå£“ï¼š<strong>${rec?.dia ?? "-"}</strong></div>
        <div class="mono">æ”¶ç¸®å£“ï¼š<strong>${rec?.sys ?? "-"}</strong></div>
        <div class="mono">å¿ƒè·³ï¼š<strong>${rec?.hr ?? "-"}</strong></div>
        <div><button class="ghost" data-load="${dateStr}">è¼‰å…¥</button></div>
      `;
      row.querySelector("button[data-load]").addEventListener("click", () => {
        switchDate(dateStr);
        showToast("å·²è¼‰å…¥è©²æ—¥ ğŸ“Œ");
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
      return row;
    }

    function getDatesBetweenInclusive(fromStr, toStr){
      const out = [];
      let cur = fromStr;
      while (cur <= toStr){
        out.push(cur);
        cur = addDays(cur, 1);
      }
      return out;
    }

    function renderHistoryByDates(dates){
      const all = loadAll();
      // åªé¡¯ç¤ºæœ‰ç´€éŒ„çš„æ—¥æœŸï¼ˆä½†ä¾æ—¥æœŸé †åºï¼‰
      const existing = dates.filter(d => all[d]);
      clearHistoryRows();

      if (existing.length === 0){
        el.emptyText.style.display = "block";
        el.emptyText.textContent = "é€™å€‹å€é–“å°šç„¡è³‡æ–™";
        return;
      }
      el.emptyText.style.display = "none";

      // æ–°åˆ°èˆŠï¼ˆé•·è¼©é€šå¸¸æƒ³å…ˆçœ‹æœ€è¿‘ï¼‰
      existing.sort((a,b) => (a < b ? 1 : -1)).forEach(dateStr => {
        el.historyList.appendChild(buildHistoryRow(dateStr, all[dateStr]));
      });
    }

    function setHint(text){ el.historyHint.textContent = text; }

    function queryLastNDays(n){
      const to = toISODate(new Date());
      const from = addDays(to, -(n-1));
      currentQuery = { mode: "range", from, to, label: `æœ€è¿‘ ${n} å¤©` };

      el.fromDate.value = from;
      el.toDate.value = to;

      setHint(`é¡¯ç¤ºï¼š${from} ï½ ${to}ï¼ˆ${n} å¤©ï¼‰`);
      renderHistoryByDates(getDatesBetweenInclusive(from, to));
    }

    function queryRange(from, to){
      if (!from || !to){
        showToast("è«‹é¸èµ·æ—¥èˆ‡è¿„æ—¥");
        return;
      }
      if (from > to){
        showToast("èµ·æ—¥ä¸å¯å¤§æ–¼è¿„æ—¥");
        return;
      }
      currentQuery = { mode:"range", from, to, label: "å€é–“æŸ¥è©¢" };
      setHint(`é¡¯ç¤ºï¼š${from} ï½ ${to}`);
      renderHistoryByDates(getDatesBetweenInclusive(from, to));
    }

    function refreshHistoryKeepCurrentQuery(){
      if (currentQuery.mode === "range"){
        renderHistoryByDates(getDatesBetweenInclusive(currentQuery.from, currentQuery.to));
        return;
      }
      // fallback
      queryLastNDays(7);
    }

    // --- äº‹ä»¶ç¶å®š ---
    el.diaRange.addEventListener("input", () => { refreshNumbers(); scheduleAutoSave(); });
    el.sysRange.addEventListener("input", () => { refreshNumbers(); scheduleAutoSave(); });
    el.hrRange.addEventListener("input",  () => { refreshNumbers(); scheduleAutoSave(); });
    el.noteInput.addEventListener("input", () => scheduleAutoSave());

    el.btnSave.addEventListener("click", () => saveNow(false));

    el.btnClearDay.addEventListener("click", () => {
      const dateStr = el.dateInput.value;
      if (!dateStr) return;

      deleteRecord(dateStr);
      applyToUI(null);
      setDirty(false);
      showToast("å·²æ¸…é™¤ç•¶æ—¥ ğŸ§¹");
      el.statusText.textContent = "ç•¶æ—¥å·²æ¸…é™¤ï¼ˆå›åˆ°é è¨­å€¼ï¼‰";
      refreshHistoryKeepCurrentQuery();
    });

    el.btnPrev.addEventListener("click", () => {
      const cur = el.dateInput.value;
      if (!cur) return;
      switchDate(addDays(cur, -1));
    });
    el.btnNext.addEventListener("click", () => {
      const cur = el.dateInput.value;
      if (!cur) return;
      switchDate(addDays(cur, 1));
    });
    el.btnToday.addEventListener("click", () => switchDate(toISODate(new Date())));
    el.dateInput.addEventListener("change", () => { if (el.dateInput.value) switchDate(el.dateInput.value); });

    // history buttons
    el.btnLast7.addEventListener("click", () => queryLastNDays(7));
    el.btnLast30.addEventListener("click", () => queryLastNDays(30));
    el.btnQuery.addEventListener("click", () => queryRange(el.fromDate.value, el.toDate.value));
    el.btnResetQuery.addEventListener("click", () => queryLastNDays(7));

    // --- åˆå§‹å•Ÿå‹• ---
    (function init(){
      const today = toISODate(new Date());
      el.dateInput.value = today;

      const rec = getRecord(today);
      applyToUI(rec);
      el.statusText.textContent = rec ? "å·²è¼‰å…¥ä»Šæ—¥ç´€éŒ„" : "ä»Šå¤©å°šæœªæœ‰ç´€éŒ„ï¼ˆå¯ç›´æ¥è¼¸å…¥ï¼‰";
      setDirty(false);

      // é è¨­æ­·å²ï¼šæœ€è¿‘ 7 å¤©
      queryLastNDays(7);
    })();
  </script>
</body>
</html>
